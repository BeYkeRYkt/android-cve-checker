From e9e7bea41cf8096a54ceb453b0d1d5ceef4b03bd Mon Sep 17 00:00:00 2001
From: Steve Pfetsch <spfetsch@google.com>
Date: Fri, 6 Apr 2018 15:09:09 -0700
Subject: [PATCH] input: touchscreen: stm: fix OOB writes in ftm4 driver

Correctly check buffer size in store_cmd and strlcpy correct length
in store_upgrade.

Bug: 68343441
Change-Id: I88140f74a793f30bbce2d95e0c9a8f8f1a52eaf2
Signed-off-by: Steve Pfetsch <spfetsch@google.com>
---
 drivers/input/touchscreen/stm/ftm4_pdc.c | 12 +++++++++---
 1 file changed, 9 insertions(+), 3 deletions(-)

diff --git a/drivers/input/touchscreen/stm/ftm4_pdc.c b/drivers/input/touchscreen/stm/ftm4_pdc.c
index a11bdd8822480..66a1d91262475 100644
--- a/drivers/input/touchscreen/stm/ftm4_pdc.c
+++ b/drivers/input/touchscreen/stm/ftm4_pdc.c
@@ -181,8 +181,8 @@ static DEVICE_ATTR(cmd, S_IWUSR | S_IWGRP, NULL, store_cmd);
 static DEVICE_ATTR(cmd_status, S_IRUGO, show_cmd_status, NULL);
 static DEVICE_ATTR(cmd_result, S_IRUGO, show_cmd_result, NULL);
 static DEVICE_ATTR(cmd_list, S_IRUGO, cmd_list_show, NULL);
-static DEVICE_ATTR(fw_upgrade, S_IWUSR | S_IWGRP, NULL, store_upgrade);
-static DEVICE_ATTR(check_fw, S_IWUSR | S_IWGRP, NULL, store_check_fw);
+static DEVICE_ATTR(fw_upgrade, S_IWUSR, NULL, store_upgrade);
+static DEVICE_ATTR(check_fw, S_IWUSR, NULL, store_check_fw);
 static DEVICE_ATTR(version, S_IRUGO, show_version_info, NULL);
 static DEVICE_ATTR(vrmode, S_IRUSR | S_IRGRP | S_IWUSR | S_IWGRP,
 		   show_vrmode, store_vrmode);
@@ -238,7 +238,7 @@ static ssize_t store_upgrade(struct device *dev,
 	struct fts_ts_info *info = dev_get_drvdata(dev);
 	int ret = 0;
 
-	if (strlcpy(&info->test_fwpath[0], buf, count) <= 0) {
+	if (strlcpy(info->test_fwpath, buf, sizeof(info->test_fwpath)) <= 0) {
 		tsp_debug_err(&info->client->dev, "%s: invalid firmware name\n", __func__);
 		return -EINVAL;
 	}
@@ -422,6 +422,12 @@ static ssize_t store_cmd(struct device *dev, struct device_attribute *devattr,
 		return -EINVAL;
 	}
 
+	if (count == 0) {
+		tsp_debug_err(&info->client->dev,
+				"%s: no argument provided\n", __func__);
+		return -EINVAL;
+	}
+
 	if (count > CMD_STR_LEN) {
 		tsp_debug_err(&info->client->dev,
 				"%s: overflow command length\n", __func__);
