From 52cbe5951c1a1b1b39eddde801186b0d8308b026 Mon Sep 17 00:00:00 2001
From: Jonathan Solnit <jsolnit@google.com>
Date: Fri, 27 Apr 2018 12:40:32 -0700
Subject: [PATCH] ASoC: msm: check payload size before memory allocation

Buffer from mixer ctl is composed of payload size and actual
payload. Unexpected payload size may lead to overflow. Check
payload size against max buffer size of mixer ctl.

Bug: 72710411
Bug: 73242483

Change-Id: I6255949344c7ec9ae3ffefdc6cbef286881996fa
Signed-off-by: Xiaojun Sang <xsang@codeaurora.org>
Signed-off-by: Jonathan Solnit <jsolnit@google.com>
---
 sound/soc/msm/qdsp6v2/msm-qti-pp-config.c | 13 ++++++++++---
 1 file changed, 10 insertions(+), 3 deletions(-)

diff --git a/sound/soc/msm/qdsp6v2/msm-qti-pp-config.c b/sound/soc/msm/qdsp6v2/msm-qti-pp-config.c
index d4e78604f868b..5258d392fd50a 100644
--- a/sound/soc/msm/qdsp6v2/msm-qti-pp-config.c
+++ b/sound/soc/msm/qdsp6v2/msm-qti-pp-config.c
@@ -1,4 +1,4 @@
-/* Copyright (c) 2012-2017, The Linux Foundation. All rights reserved.
+/* Copyright (c) 2012-2018, The Linux Foundation. All rights reserved.
  *
  * This program is free software; you can redistribute it and/or modify
  * it under the terms of the GNU General Public License version 2 and
@@ -25,6 +25,7 @@
 #include "msm-qti-pp-config.h"
 #include "msm-pcm-routing-v2.h"
 
+#define MAX_MIXER_CTL_BUF_SIZE 512
 /* EQUALIZER */
 /* Equal to Frontend after last of the MULTIMEDIA SESSIONS */
 #define MAX_EQ_SESSIONS		MSM_FRONTEND_DAI_CS_VOICE
@@ -877,7 +878,7 @@ int msm_adsp_stream_cmd_info(struct snd_kcontrol *kcontrol,
 			struct snd_ctl_elem_info *uinfo)
 {
 	uinfo->type = SNDRV_CTL_ELEM_TYPE_BYTES;
-	uinfo->count = 512;
+	uinfo->count = MAX_MIXER_CTL_BUF_SIZE;
 
 	return 0;
 }
@@ -890,6 +891,12 @@ int msm_adsp_stream_callback_put(struct snd_kcontrol *kcontrol,
 	/* fetch payload size in first four bytes */
 	memcpy(&payload_size, ucontrol->value.bytes.data, sizeof(uint32_t));
 
+	if (payload_size > MAX_MIXER_CTL_BUF_SIZE - sizeof(payload_size)) {
+		pr_err("%s: payload_size=%d is over mixer ctl buffer limit.",
+			__func__, payload_size);
+		return -EINVAL;
+	}
+
 	if (kcontrol->private_data == NULL) {
 		/* buffer is empty */
 		kcontrol->private_data =
@@ -942,7 +949,7 @@ int msm_adsp_stream_callback_info(struct snd_kcontrol *kcontrol,
 			struct snd_ctl_elem_info *uinfo)
 {
 	uinfo->type = SNDRV_CTL_ELEM_TYPE_BYTES;
-	uinfo->count = 512;
+	uinfo->count = MAX_MIXER_CTL_BUF_SIZE;
 
 	return 0;
 }
