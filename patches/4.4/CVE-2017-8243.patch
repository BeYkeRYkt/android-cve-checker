From 59138462e241e7e09130e33fb7f31fae17f2e314 Mon Sep 17 00:00:00 2001
From: Nick Desaulniers <ndesaulniers@google.com>
Date: Mon, 15 May 2017 13:31:50 -0700
Subject: [PATCH] soc: qcom: pil: Avoid possible buffer overflow during Modem
 boot

Buffer overflow can occur if MBA firmware size exceeds 1MB.
So validate size before copying the firmware.

Bug: 34112490
CRs-Fixed: 2001803

Change-Id: I2c64ac17c662da191db9e43e4207f12a3377dcdc
Signed-off-by: Nick Desaulniers <ndesaulniers@google.com>
---
 drivers/soc/qcom/pil-msa.c | 8 ++++++++
 1 file changed, 8 insertions(+)

diff --git a/drivers/soc/qcom/pil-msa.c b/drivers/soc/qcom/pil-msa.c
index 53bddc5987dfb..f205cc1469f01 100644
--- a/drivers/soc/qcom/pil-msa.c
+++ b/drivers/soc/qcom/pil-msa.c
@@ -616,6 +616,14 @@ int pil_mss_reset_load_mba(struct pil_desc *pil)
 
 	/* Load the MBA image into memory */
 	count = fw->size;
+
+	if (count > SZ_1M) {
+		dev_err(pil->dev, "%s fw image loading into memory is failed due to fw size overflow\n",
+			__func__);
+		ret = -EINVAL;
+		goto err_mba_data;
+	}
+
 	memcpy(mba_dp_virt, data, count);
 	/* Ensure memcpy of the MBA memory is done before loading the DP */
 	wmb();
