From a989f5c6398175cc7354b9cdf0424449f8dd9860 Mon Sep 17 00:00:00 2001
From: Lloyd Atkinson <latkinso@codeaurora.org>
Date: Mon, 28 Aug 2017 11:54:42 -0400
Subject: drm/msm: use local non-blocking flag to avoid use after free

Avoid checking nonblock flag in the commit packet that gets
dispatched to a worker thread, since that worker thread may free
the commit packet before the dispatch thread has a chance to
read it again after the commit dispatch loop.

Change-Id: Idcbc17dd1cb6df15d0f9607b589587d6f03ee4ff
Signed-off-by: Lloyd Atkinson <latkinso@codeaurora.org>
---
 drivers/gpu/drm/msm/msm_atomic.c | 11 +++++++++--
 1 file changed, 9 insertions(+), 2 deletions(-)

diff --git a/drivers/gpu/drm/msm/msm_atomic.c b/drivers/gpu/drm/msm/msm_atomic.c
index 0c1bcf6..e0617ee 100644
--- a/drivers/gpu/drm/msm/msm_atomic.c
+++ b/drivers/gpu/drm/msm/msm_atomic.c
@@ -476,6 +476,10 @@ static void msm_atomic_commit_dispatch(struct drm_device *dev,
 	struct drm_crtc *crtc = NULL;
 	struct drm_crtc_state *crtc_state = NULL;
 	int ret = -EINVAL, i = 0, j = 0;
+	bool nonblock;
+
+	/* cache since work will kfree commit in non-blocking case */
+	nonblock = commit->nonblock;
 
 	for_each_crtc_in_state(state, crtc, crtc_state, i) {
 		for (j = 0; j < priv->num_crtcs; j++) {
@@ -515,10 +519,13 @@ static void msm_atomic_commit_dispatch(struct drm_device *dev,
 		 */
 		DRM_ERROR("failed to dispatch commit to any CRTC\n");
 		complete_commit(commit);
-	} else if (!commit->nonblock) {
+	} else if (!nonblock) {
 		kthread_flush_work(&commit->commit_work);
-		kfree(commit);
 	}
+
+	/* free nonblocking commits in this context, after processing */
+	if (!nonblock)
+		kfree(commit);
 }
 
 /**
-- 
cgit v1.1

